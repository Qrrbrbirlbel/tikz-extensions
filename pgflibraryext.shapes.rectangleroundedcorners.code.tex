\usepgflibrary{intersections}%
\pgfset{
  rectangle with rounded corners north west radius/.initial=.5\pgflinewidth,
  rectangle with rounded corners north east radius/.initial=.5\pgflinewidth,
  rectangle with rounded corners south west radius/.initial=.5\pgflinewidth,
  rectangle with rounded corners south east radius/.initial=.5\pgflinewidth,
  rectangle with rounded corners radius/.style={
    /pgf/rectangle with rounded corners north west radius={#1},
    /pgf/rectangle with rounded corners north east radius={#1},
    /pgf/rectangle with rounded corners south west radius={#1},
    /pgf/rectangle with rounded corners south east radius={#1}}
}%
\pgfdeclareshape{rectangle with rounded corners}{%
  \savedmacro\rectanglewithroundedcornersparameter{%
    %
    % width = max(text width + 2 * inner xseps, minimum width) + 2 * outer xseps
    \pgf@x=\wd\pgfnodeparttextbox
    \pgfmathsetlength\pgf@xc{\pgfkeysvalueof{/pgf/inner xsep}}%
    \advance\pgf@x by 2\pgf@xc
    \pgfmathsetlength\pgf@xc{\pgfkeysvalueof{/pgf/minimum width}}%
    \ifdim\pgf@x<\pgf@xc
      \pgf@x=\pgf@xc
    \fi
    %
    \pgfmathsetlength\pgf@xc{\pgfkeysvalueof{/pgf/outer xsep}}%
    \edef\outerxsep{\the\pgf@xc}%
    \addtosavedmacro\outerxsep
    \advance\pgf@x by 2\pgf@xc
    \pgf@x=.5\pgf@x
    \edef\halfwidth{\the\pgf@x}%
    \addtosavedmacro\halfwidth
    %
    % height = max(text height + text depth + 2 * inner yseps, minimum height) + 2 * outer yseps
    \pgf@y=\ht\pgfnodeparttextbox
    \advance\pgf@y by \dp\pgfnodeparttextbox
    \pgfmathsetlength\pgf@yc{\pgfkeysvalueof{/pgf/inner ysep}}%
    \advance\pgf@y by 2\pgf@yc
    \pgfmathsetlength\pgf@yc{\pgfkeysvalueof{/pgf/minimum height}}%
    \ifdim\pgf@y<\pgf@yc
      \pgf@y=\pgf@yc
    \fi
    %
    \pgfmathsetlength\pgf@yc{\pgfkeysvalueof{/pgf/outer ysep}}%
    \edef\outerysep{\the\pgf@yc}%
    \addtosavedmacro\outerysep
    \advance\pgf@y by 2\pgf@yc
    \pgf@y=.5\pgf@y
    \edef\halfheight{\the\pgf@y}%
    \addtosavedmacro\halfheight
    %
    % \centerpoint
    \pgf@x=.5\wd\pgfnodeparttextbox
    \pgf@y=.5\ht\pgfnodeparttextbox
    \advance\pgf@y by -.5\dp\pgfnodeparttextbox
    \pgfextract@process\centerpoint{}%
    \addtosavedmacro\centerpoint
    %
    \pgfmathsetlengthmacro\northwestradius{\pgfkeysvalueof{/pgf/rectangle with rounded corners north west radius}}
    \pgfmathsetlengthmacro\northeastradius{\pgfkeysvalueof{/pgf/rectangle with rounded corners north east radius}}
    \pgfmathsetlengthmacro\southwestradius{\pgfkeysvalueof{/pgf/rectangle with rounded corners south west radius}}
    \pgfmathsetlengthmacro\southeastradius{\pgfkeysvalueof{/pgf/rectangle with rounded corners south east radius}}
    \addtosavedmacro\northwestradius
    \addtosavedmacro\northeastradius
    \addtosavedmacro\southwestradius
    \addtosavedmacro\southeastradius
  }%
  \anchor{center}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
  }
  \anchor{west}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
    \advance\pgf@x by -\halfwidth
  }
  \anchor{east}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
    \advance\pgf@x by \halfwidth
  }
  \anchor{north}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
    \advance\pgf@y by \halfheight
  }
  \anchor{south}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
    \advance\pgf@y by -\halfheight
  }
  \anchor{mid}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
    \pgfmathsetlength\pgf@y{+.5ex}%
  }
  \anchor{mid west}{%
    \csname pgf@anchor@rectangle with rounded corners@west\endcsname
    \pgfmathsetlength\pgf@y{+.5ex}%
  }
  \anchor{mid east}{%
    \csname pgf@anchor@rectangle with rounded corners@east\endcsname
    \pgfmathsetlength\pgf@y{+.5ex}%
  }
  \anchor{base}{%
    \rectanglewithroundedcornersparameter
    \centerpoint
    \pgf@y=0pt
  }
  \anchor{base west}{%
    \csname pgf@anchor@rectangle with rounded corners@west\endcsname
    \pgf@y=0pt
  }
  \anchor{base east}{%
    \csname pgf@anchor@rectangle with rounded corners@east\endcsname
    \pgf@y=0pt
  }
  \anchor{north west}{%
    \csname pgf@anchor@rectangle with rounded corners@north west center\endcsname
    \ifdim\northwestradius=0pt
    \else
      \pgf@process{\pgfpointadd{}{\pgfpointpolar{135}{\northwestradius+\outerxsep and \northwestradius+\outerysep}}}%
    \fi
  }
  \anchor{north west center}{%
    \rectanglewithroundedcornersparameter
    \pgf@x=-\halfwidth
    \pgf@y=\halfheight
    \ifdim\northwestradius=0pt
    \else
      \advance\pgf@x by \outerxsep
      \advance\pgf@x by \northwestradius
      \advance\pgf@y by -\outerysep
      \advance\pgf@y by -\northwestradius
    \fi
    \pgf@process{\pgfpointadd{}{\centerpoint}}%
  }
  \anchor{north east}{%
    \csname pgf@anchor@rectangle with rounded corners@north east center\endcsname
    \ifdim\northeastradius=0pt
    \else
      \pgf@process{\pgfpointadd{}{\pgfpointpolar{45}{\northeastradius+\outerxsep and \northeastradius+\outerysep}}}%
    \fi
  }
  \anchor{north east center}{%
    \rectanglewithroundedcornersparameter
    \pgf@x=\halfwidth
    \pgf@y=\halfheight
    \ifdim\northeastradius=0pt
    \else
      \advance\pgf@x by -\outerxsep
      \advance\pgf@x by -\northeastradius
      \advance\pgf@y by -\outerysep
      \advance\pgf@y by -\northeastradius
    \fi
    \pgf@process{\pgfpointadd{}{\centerpoint}}%
  }
  \anchor{south west}{%
    \csname pgf@anchor@rectangle with rounded corners@south west center\endcsname
    \ifdim\southwestradius=0pt
    \else
      \pgf@process{\pgfpointadd{}{\pgfpointpolar{225}{\southwestradius+\outerxsep and \southwestradius+\outerysep}}}%
    \fi
  }
  \anchor{south west center}{%
    \rectanglewithroundedcornersparameter
    \pgf@x=-\halfwidth
    \pgf@y=-\halfheight
    \ifdim\southwestradius=0pt
    \else
      \advance\pgf@x by \outerxsep
      \advance\pgf@x by \southwestradius
      \advance\pgf@y by \outerysep
      \advance\pgf@y by \southwestradius
    \fi
    \pgf@process{\pgfpointadd{}{\centerpoint}}%
  }
  \anchor{south east}{%
    \csname pgf@anchor@rectangle with rounded corners@south east center\endcsname
    \ifdim\southeastradius=0pt
    \else
      \pgf@process{\pgfpointadd{}{\pgfpointpolar{315}{\southeastradius+\outerxsep and \southeastradius+\outerysep}}}%
    \fi
  }
  \anchor{south east center}{%
    \rectanglewithroundedcornersparameter
    \pgf@x=\halfwidth
    \pgf@y=-\halfheight
    \ifdim\southeastradius=0pt
    \else
      \advance\pgf@x by -\outerxsep
      \advance\pgf@x by -\southeastradius
      \advance\pgf@y by \outerysep
      \advance\pgf@y by \southeastradius
    \fi
    \pgf@process{\pgfpointadd{}{\centerpoint}}%
  }
  \backgroundpath{%
    \rectanglewithroundedcornersparameter
    %
    \pgf@xa=\halfwidth
    \advance\pgf@xa by -\outerxsep
    \edef\HalfWidth{\the\pgf@xa}%
    %
    \pgf@ya=\halfheight
    \advance\pgf@ya by -\outerysep
    \edef\HalfHeight{\the\pgf@ya}%
    %
    \pgftransformshift{\centerpoint}%
    %
    \pgfpathmoveto{\pgfqpoint{\HalfWidth}{0pt}}%
    \pgfpathlineto{\pgfpoint {+\HalfWidth}{\HalfHeight-\northeastradius}}%
    \pgfpatharc{0}{90}{\northeastradius}%
    \pgfpathlineto{\pgfpoint{-\HalfWidth+\northwestradius}{+\HalfHeight}}
    \pgfpatharc{90}{180}{\northwestradius}%
    \pgfpathlineto{\pgfpoint{+-\HalfWidth}{-\HalfHeight+\southwestradius}}%
    \pgfpatharc{180}{270}{\southwestradius}%
    \pgfpathlineto{\pgfpoint{\HalfWidth-\southeastradius}{+-\HalfHeight}}%
    \pgfpatharc{270}{360}{\southeastradius}%
    \pgfpathclose
    \pgftransformshift{\pgfqpointscale{-1}{\centerpoint}}%
  }%
%   \anchorborder{%
%     \pgf@xb=\pgf@x
%     \pgf@yb=\pgf@y
%     \pgf@process{\pgf@sh@reanchor{split rectangle with rounded corners}{south}}%
%     \pgf@ya\pgf@y
%     \pgf@process{\pgf@sh@reanchor{split rectangle with rounded corners}{west}}%
%     \pgf@xa\pgf@x
%     \pgf@process{\pgf@sh@reanchor{split rectangle with rounded corners}{north}}%
%     \pgf@yc\pgf@y
%     \pgf@process{\pgf@sh@reanchor{split rectangle with rounded corners}{east}}%
%     \pgf@y\pgf@yc
%     \advance\pgf@x by-\pgf@xa%
%     \advance\pgf@y by-\pgf@ya%
%     \pgf@xc=.5\pgf@x% x/y is half width/height
%     \pgf@yc=.5\pgf@y%
%     \advance\pgf@xa by\pgf@xc% xa/ya becomes center
%     \advance\pgf@ya by\pgf@yc%
%     \edef\pgf@marshal{%
%       \noexpand\pgfpointborderrectangle
%       {\noexpand\pgfqpoint{\the\pgf@xb}{\the\pgf@yb}}
%       {\noexpand\pgfqpoint{\the\pgf@xc}{\the\pgf@yc}}%
%     }%
%     \pgf@process{\pgf@marshal}%
%     \advance\pgf@xa by\pgf@x%
%     \advance\pgf@ya by\pgf@y%
%     %
%     \pgfutil@tempdima\pgf@xa
%     \pgfutil@tempdimb\pgf@ya
% %    \pgf@x\pgf@xa
% %    \pgf@y\pgf@ya
%     \splitrectanglewithroundedcornersparameter
%     \centerpoint
%     \pgf@xc\pgf@x
%     \pgf@yc\pgf@y
%     \ifdim\pgfutil@tempdima>\pgf@xc
%       \ifdim\pgfutil@tempdimb>\pgf@yc % north east
%         \pgf@lib@sh@qrr@get@radius@and@center0\pgfutil@tempdima\pgfutil@tempdimb
%       \else                 % south east
%         \pgf@lib@sh@qrr@get@radius@and@center3\pgfutil@tempdima\pgfutil@tempdimb
%       \fi
%     \else
%       \ifdim\pgfutil@tempdimb>\pgf@yc % north west
%         \pgf@lib@sh@qrr@get@radius@and@center1\pgfutil@tempdima\pgfutil@tempdimb
%       \else                 % south west
%         \pgf@lib@sh@qrr@get@radius@and@center2\pgfutil@tempdima\pgfutil@tempdimb
%       \fi
%     \fi
%   }
}
% \def\pgf@lib@sh@qrr@get@radius@and@center#1#2#3{%
%   \begingroup
%     \pgfutil@tempswafalse
%     \ifcase#1% north east
%       \def\pgf@tempa{1}%
%       \leftnortheast
%       \pgf@xa\pgf@x
%       \pgf@ya\pgf@y
%       \pgf@yb\pgf@y
%       \abovesoutheast
%       \advance\pgf@ya-\pgf@x
%       \advance\pgf@ya\pgf@xa
%       \advance\pgf@yb-\pgf@ya
%       \ifdim#3>\pgf@ya
%         \ifdim#2>\pgf@xa
%           \pgfutil@tempswatrue
%         \fi
%       \fi
%     \or      % north west
%       \def\pgf@tempa{1}%
%       \belownorthwest
%       \pgf@xa\pgf@x
%       \pgf@yb-\pgf@x
%       \pgf@ya\pgf@y
%       \leftnortheast
%       \advance\pgf@xa\pgf@y
%       \advance\pgf@xa-\pgf@ya
%       \advance\pgf@yb\pgf@xa
%       \ifdim#3>\pgf@ya
%         \ifdim#2<\pgf@xa
%           \pgfutil@tempswatrue
%         \fi
%       \fi
%     \or      % south west
%       \def\pgf@tempa{2}%
%       \rightsouthwest
%       \pgf@xa\pgf@x
%       \pgf@ya\pgf@y
%       \pgf@yb-\pgf@y
%       \belownorthwest
%       \advance\pgf@ya-\pgf@x
%       \advance\pgf@ya\pgf@xa
%       \advance\pgf@yb\pgf@ya
%       \ifdim#3<\pgf@ya
%         \ifdim#2<\pgf@xa
%           \pgfutil@tempswatrue
%         \fi
%       \fi
%     \else    % south east
%       \def\pgf@tempa{2}%
%       \abovesoutheast
%       \pgf@ya\pgf@y
%       \pgf@yb\pgf@x
%       \pgf@xa\pgf@x
%       \rightsouthwest
%       \advance\pgf@xa\pgf@y
%       \advance\pgf@xa-\pgf@ya
%       \advance\pgf@yb-\pgf@xa
%       \ifdim#3<\pgf@ya
%         \ifdim#2>\pgf@xa
%           \pgfutil@tempswatrue
%         \fi
%       \fi
%     \fi
%     \pgfinterruptboundingbox
%       \ifpgfutil@tempswa
%         \pgfintersectionofpaths{
%           \pgfpathmoveto{\pgfqpoint{\pgf@xc}{\pgf@yc}}%
%           \pgfpathlineto{\pgfqpoint{#2}{#3}}%
%         }{%
%           \pgfpathcircle{\pgfqpoint{\pgf@xa}{\pgf@ya}}{\pgf@yb}%
%         }%
%         \pgfpointintersectionsolution{\pgf@tempa}
%         \pgftransforminvert
%         \pgfpointtransformed{}%
%       \else
%         \pgf@process{\pgfqpoint{#2}{#3}}%
%       \fi
%     \endpgfinterruptboundingbox
%   \endgroup
% }
\endinput
