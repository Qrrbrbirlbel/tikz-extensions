% Copyright 2022 by Qrrbrbirlbel
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Free Documentation License.
%
\usepgflibrary{shapes.geometric,intersections}
\pgfset{
  superellipse x exponent/.initial=2.5,
  superellipse y exponent/.initial=2.5,
  superellipse step/.initial=4,
  superellipse exponent/.style={/pgf/superellipse x exponent={#1},/pgf/superellipse y exponent={#1}}}
\pgfmathdeclarefunction{superellipsex}{3}{% #1 = t (0≤t≤90), #2 = 2/m (x-exp), #3 = a (x-rad)
  \pgfmathcos@{#1}%
  \pgfmathpow@{\pgfmathresult}{#2}%
  \pgfmathmultiply@{\pgfmathresult}{#3}}
\pgfmathdeclarefunction{superellipsey}{3}{% #1 = t (0≤t≤90), #2 = 2/n (y-exp), #3 = a (y-rad)
  \pgfmathsin@{#1}%
  \pgfmathpow@{\pgfmathresult}{#2}%
  \pgfmathmultiply@{\pgfmathresult}{#3}}
\def\pgfmathsuperellipseXY#1#2#3#4#5{% #1 = t (0≤t≤90), #2 = 2/m (x-exp), #3 = 2/n (y-exp), #4 = a (x-rad), #5 = b (y-rad)
  \begingroup
    \pgfmathsuperellipsex{#1}{#2}{#4}%
    \let\pgfmath@temp\pgfmathresult
    \pgfmathsuperellipsey{#1}{#3}{#5}%
    \edef\pgfmath@temp{\def\noexpand\pgfmathresultX{\pgfmath@temp}\def\noexpand\pgfmathresultY{\pgfmathresult}}%
    \expandafter
  \endgroup\pgfmath@temp}
\pgfdeclareshape{superellipse}{%
  \inheritsavedanchors[from=ellipse]
  \inheritanchor[from=ellipse]{text}\inheritanchor[from=ellipse]{center}
  \inheritanchor[from=ellipse]{mid}\inheritanchor[from=ellipse]{base}
  \inheritanchor[from=ellipse]{north}\inheritanchor[from=ellipse]{south}
  \inheritanchor[from=ellipse]{west}\inheritanchor[from=ellipse]{east}
  \inheritanchor[from=ellipse]{mid west}\inheritanchor[from=ellipse]{base west}
  \inheritanchor[from=ellipse]{mid east}\inheritanchor[from=ellipse]{base east}
  \anchor{north east}{%
    \pgf@process{\radius}%
    \pgfmathpow@{.70710678118}{\xexponent}%
    \pgf@x=\pgfmathresult\pgf@x
    \pgfmathpow@{.70710678118}{\yexponent}%
    \pgf@y=\pgfmathresult\pgf@y
    \pgfpointadd{}{\centerpoint}%
  }
  \anchor{north west}{%
    \pgf@process{\radius}%
    \pgfmathpow@{.70710678118}{\xexponent}%
    \pgf@x=-\pgfmathresult\pgf@x
    \pgfmathpow@{.70710678118}{\yexponent}%
    \pgf@y=\pgfmathresult\pgf@y
    \pgfpointadd{}{\centerpoint}%
  }
  \anchor{south west}{%
    \pgf@process{\radius}%
    \pgfmathpow@{.70710678118}{\xexponent}%
    \pgf@x=-\pgfmathresult\pgf@x
    \pgfmathpow@{.70710678118}{\yexponent}%
    \pgf@y=-\pgfmathresult\pgf@y
    \pgfpointadd{}{\centerpoint}%
  }
  \anchor{south east}{%
    \pgf@process{\radius}%
    \pgfmathpow@{.70710678118}{\xexponent}%
    \pgf@x=\pgfmathresult\pgf@x
    \pgfmathpow@{.70710678118}{\yexponent}%
    \pgf@y=-\pgfmathresult\pgf@y
    \pgfpointadd{}{\centerpoint}%
  }
  \savedmacro\xexponent{%
    \pgfmathreciprocal{\pgfkeysvalueof{/pgf/superellipse x exponent}}%
    \pgfmathmultiply@{\pgfmathresult}{2}%
    \let\xexponent\pgfmathresult
  }
  \savedmacro\yexponent{%
    \pgfmathreciprocal{\pgfkeysvalueof{/pgf/superellipse y exponent}}%
    \pgfmathmultiply@{\pgfmathresult}{2}%
    \let\yexponent\pgfmathresult
  }
  \savedmacro\step{%
    \pgfmathsetmacro\step{\pgfkeysvalueof{/pgf/superellipse step}}}
  \savedmacro\plothandler{\pgfkeysgetvalue{/pgf/superellipse smooth}\plothandler}
  \backgroundpath{%
    \pgf@process{\radius}%
    \pgfmathsetlengthmacro\xradius{\pgf@x-\pgfkeysvalueof{/pgf/outer xsep}}%
    \pgfmathsetlengthmacro\yradius{\pgf@y-\pgfkeysvalueof{/pgf/outer ysep}}%
    \let\pgf@tempd\pgfutil@empty
    \let\pgf@tempa\pgfutil@empty
    \let\pgf@tempb\pgfutil@empty
    \let\pgf@tempc\pgfutil@empty
    \c@pgf@counta=\step
    \pgfutil@loop
    \ifnum\c@pgf@counta<90
      \pgfmathsuperellipseXY{\the\c@pgf@counta}{\xexponent}{\yexponent}{\xradius}{\yradius}%
      \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{\pgfmathresultX pt}{\pgfmathresultY pt}}}%
      \pgfutil@append@macrotomacro\pgf@tempd\pgf@temp
      \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{-\pgfmathresultX pt}{\pgfmathresultY pt}}}%
      \pgfutil@prefix@macrotomacro\pgf@tempa\pgf@temp
      \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{-\pgfmathresultX pt}{-\pgfmathresultY pt}}}%
      \pgfutil@append@macrotomacro\pgf@tempb\pgf@temp
      \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{\pgfmathresultX pt}{-\pgfmathresultY pt}}}%
      \pgfutil@prefix@macrotomacro\pgf@tempc\pgf@temp
      \advance\c@pgf@counta by\step
    \pgfutil@repeat
    \pgftransformshift{\centerpoint}%
    \pgfplothandlerclosedcurve
    \pgfplotstreamstart
    \pgfplotstreampoint{\pgfqpoint{\xradius}{0pt}}%
    \pgf@tempd
    \pgfplotstreampoint{\pgfqpoint{0pt}{\yradius}}%
    \pgf@tempa
    \pgfplotstreampoint{\pgfqpoint{-\xradius}{0pt}}%
    \pgf@tempb
    \pgfplotstreampoint{\pgfqpoint{0pt}{-\yradius}}%
    \pgf@tempc
    \pgfplotstreamend
    \pgftransformshift{\centerpoint\pgf@x=-\pgf@x\pgf@y=-\pgf@y}
  }
  \anchorborder{%
    \pgfextract@process\externalpoint{}%
    \ifdim\pgf@x=0pt % catch special case x = 0
      \ifdim\pgf@y<0pt \pgf@anchor@superellipse@south\else\pgf@anchor@superellipse@north\fi
    \else
      \ifdim\pgf@y=0pt % catch special case y = 0
        \ifdim\pgf@x<0pt \pgf@anchor@superellipse@west\else\pgf@anchor@superellipse@east\fi
      \else % both are not zero
        \pgftransformreset % weird
        \pgfintersectionofpaths{%
          \pgf@relevantforpicturesizefalse % even weirder
          \pgftransformshift{\centerpoint}%
          \pgfpathmoveto{\pgfpointorigin}%
          \pgfpathlineto{\pgfpointborderrectangle{\externalpoint}{\radius}}%
        }{% TODO: construct only quarter of path
          \pgf@relevantforpicturesizefalse % even weirder
          \pgf@process{\radius}\pgfgetlastxy\xradius\yradius
          \let\pgf@tempd\pgfutil@empty
          \let\pgf@tempa\pgfutil@empty
          \let\pgf@tempb\pgfutil@empty
          \let\pgf@tempc\pgfutil@empty
          \c@pgf@counta=\step
          \pgfutil@loop
          \ifnum\c@pgf@counta<90
            \pgfmathsuperellipseXY{\the\c@pgf@counta}{\xexponent}{\yexponent}{\xradius}{\yradius}%
            \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{\pgfmathresultX pt}{\pgfmathresultY pt}}}%
            \pgfutil@append@macrotomacro\pgf@tempd\pgf@temp
            \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{-\pgfmathresultX pt}{\pgfmathresultY pt}}}%
            \pgfutil@prefix@macrotomacro\pgf@tempa\pgf@temp
            \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{-\pgfmathresultX pt}{-\pgfmathresultY pt}}}%
            \pgfutil@append@macrotomacro\pgf@tempb\pgf@temp
            \edef\pgf@temp{\noexpand\pgfplotstreampoint{\noexpand\pgfqpoint{\pgfmathresultX pt}{-\pgfmathresultY pt}}}%
            \pgfutil@prefix@macrotomacro\pgf@tempc\pgf@temp
            \advance\c@pgf@counta by\step
          \pgfutil@repeat
          \pgftransformshift{\centerpoint}%
          \pgfplothandlerclosedcurve
          \pgfplotstreamstart
          \pgfplotstreampoint{\pgfqpoint{\xradius}{0pt}}%
          \pgf@tempd
          \pgfplotstreampoint{\pgfqpoint{0pt}{\yradius}}%
          \pgf@tempa
          \pgfplotstreampoint{\pgfqpoint{-\xradius}{0pt}}%
          \pgf@tempb
          \pgfplotstreampoint{\pgfqpoint{0pt}{-\yradius}}%
          \pgf@tempc
          \pgfplotstreamend
        }%
        \ifnum\pgfintersectionsolutions>0 % only if a solution was found
          \pgf@process{\pgfpointintersectionsolution{1}}%
        \else % otherwise take the border on the rectangle (close enough?)
          \pgf@process{\pgfpointborderrectangle{\externalpoint}{\radius}}%
        \fi
      \fi
    \fi}}
\def\pgfutil@prefix@macrotomacro#1#2{%
    \expandafter\expandafter\expandafter\def\expandafter\expandafter\expandafter%
        #1\expandafter\expandafter\expandafter{\expandafter#2#1}}
\endinput
