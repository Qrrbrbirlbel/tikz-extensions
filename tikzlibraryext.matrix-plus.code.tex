% Copyright 2022 by Qrrbrbirlbel
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Free Documentation License.
%

\usetikzlibrary{ext.node-families,ext.misc,matrix}
\pgfkeys{
    /prefix functions/tikz/execute at begin cell/.code=%
        \def\pgfkeys@temp{#1}%
        \expandafter\expandafter\expandafter\def
        \expandafter\expandafter\expandafter\tikz@atbegin@cell
        \expandafter\expandafter\expandafter{\expandafter\pgfkeys@temp\tikz@atbegin@cell},%
    /prefix functions/tikz/execute at end cell/.code=%
        \def\pgfkeys@temp{#1}%
        \expandafter\expandafter\expandafter\def
        \expandafter\expandafter\expandafter\tikz@atend@cell
        \expandafter\expandafter\expandafter{\expandafter\pgfkeys@temp\tikz@atend@cell},%
    /prefix functions/tikz/execute at empty cell/.code=%
        \def\pgfkeys@temp{#1}%
        \expandafter\expandafter\expandafter\def
        \expandafter\expandafter\expandafter\tikz@at@emptycell
        \expandafter\expandafter\expandafter{\expandafter\pgfkeys@temp\tikz@at@emptycell},%
    /handlers/.Prefix/.code={%
        \edef\pgfkeys@temp##1{\noexpand\pgfkeysalso{/prefix functions\pgfkeyscurrentpath={##1}}}%
        \pgfkeys@temp{#1}%
    }
}

\usepgfmodule{parser}
\pgfqkeys{/tikz/node family}{
    @matrix/.style={
        text height=@tikzext@matrix@row\the\pgfmatrixcurrentrow,
        text depth=@tikzext@matrix@row\the\pgfmatrixcurrentrow,
        text width=@tikzext@matrix@col\the\pgfmatrixcurrentcolumn
    }
}
\pgfparserdef{tikzext-nodefamilies-col}{initial}L[O{}]{%
    \advance\c@pgf@counta by 1
    \pgfkeysalso{/tikz/column \the\c@pgf@counta/.append code=%
        \pgfqkeys{/tikz/node family}{@matrix,text width align=left}%
        \tikzset{nodes={#1}}%
    }%
}
\pgfparserdef{tikzext-nodefamilies-col}{initial}R[O{}]{%
    \advance\c@pgf@counta by 1
    \pgfkeysalso{/tikz/column \the\c@pgf@counta/.append code=%
        \pgfqkeys{/tikz/node family}{@matrix,text width align=right}%
        \tikzset{nodes={#1}}%
    }%
}
\pgfparserdef{tikzext-nodefamilies-col}{initial}C[O{}]{%
    \advance\c@pgf@counta by 1
    \pgfkeysalso{/tikz/column \the\c@pgf@counta/.append code=%
        \pgfqkeys{/tikz/node family}{@matrix,text width align=center}%
        \tikzset{nodes={#1}}%
    }%
}
\pgfparserdef{tikzext-nodefamilies-col}{initial}|[O{}D()-]{%
    \ifnum\c@pgf@counta=0
        \edef\tikz@temp{,matrix-plus/@vertical line=%
            {{matrix-plus/vertical line first/.try,
              matrix-plus/vertical line before 1/.try,#1}{1}{.north west}{.south west}#2}}%
    \else
        \edef\tikz@temp{,matrix-plus/@vertical line=%
            {{matrix-plus/vertical line after \the\c@pgf@counta/.try,
              matrix-plus/vertical line before \the\numexpr\c@pgf@counta+1\relax/.try,#1}{\the\c@pgf@counta}{.north east}{.south east}#2}}%
    \fi
    \expandafter\pgfutil@g@addto@macro\expandafter\tikzext@matrixplus@aftermatrix\expandafter{\tikz@temp}%
}
\pgfparserdef{tikzext-nodefamilies-col}{initial}l{%
    \advance\c@pgf@counta by 1
    \pgfkeysalso{/tikz/column \the\c@pgf@counta/.append style={anchor=base west}}
}%

\pgfparserdef{tikzext-nodefamilies-col}{initial}r{%
    \advance\c@pgf@counta by 1
    \pgfkeysalso{/tikz/column \the\c@pgf@counta/.append style={anchor=base east}}
}%

\pgfparserdef{tikzext-nodefamilies-col}{initial}c{%
  \advance\c@pgf@counta by 1
  \pgfkeysalso{/tikz/column \the\c@pgf@counta/.append style={anchor=base}}
}%

\pgfparserdef{tikzext-nodefamilies-col}{initial}*[mm]{%
  \begingroup
    \pgfmathsetcount\c@pgf@countb{#1}%
    \let\tikz@temp\pgfutil@empty
    \pgfutil@loop
      \ifnum0<\c@pgf@countb
      \expandafter\def\expandafter\tikz@temp\expandafter{\tikz@temp#2}%
      \advance\c@pgf@countb by -1
    \pgfutil@repeat
    \edef\tikz@temp{\endgroup\def\noexpand\pgfparserletter{\tikz@temp}}%
    \tikz@temp
  \pgfparserreinsert
}
\pgfparserdef{tikzext-nodefamilies-col}{initial}\tikzext@stop{\pgfparserswitch{final}}

\pgfqkeys{/tikz/matrix-plus}{
    .code=\pgfqkeys{/tikz/matrix-plus}{#1},
    tight matrix/.style={/tikz/every outer matrix/.append style={/pgf/inner sep=+0pt}},
    tabular matrix/.style={/tikz/every outer matrix/.append style={/pgf/inner ysep=+0pt,/pgf/inner xsep=\tabcolsep}},
    bounding boxes/.style={
        /tikz/execute at empty cell/.Prefix=%
            \pgf@matrix@nodecallback
                {\tikz@pp@name{\tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn-bounding box}}%
            \pgfcoordinate
              {\tikz@pp@name{\tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn-bounding box}}
              {\pgfpointorigin},
        /tikz/execute at begin cell/.Prefix=%
            \pgf@matrix@nodecallback
                {\tikz@pp@name{\tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn-bounding box}}%
            \tikzset{
                local bounding box/.expanded=
                    \tikzmatrixname-\the\pgfmatrixcurrentrow-\the\pgfmatrixcurrentcolumn-bounding box}},
    columns/.code={%
        \tikzset{
            node family/prefix/.append=\tikzmatrixname-,
            /utils/exec=\gdef\tikzext@matrixplus@aftermatrix{%
                /utils/exec=%
                \edef\tikzext@matrixplus@lastrow{\the\pgfmatrixcurrentrow}%
                \edef\tikzext@matrixplus@lastcol{\the\pgfmatrixcurrentcolumn}%
                \let\tikzext@matrixplus@name\tikzlastnode
            },
            append after command={[style/.expand once=\tikzext@matrixplus@aftermatrix]},
        }%
        \c@pgf@counta=0
        \pgfparserparse{tikzext-nodefamilies-col}#1\tikzext@stop
    },
    style/.is choice,
    style/tabular/.style={
        /tikz/matrix-plus/tabular matrix,
        /pgf/inner xsep=+0pt,
        /tikz/execute at begin node=\strut,
        /pgf/inner ysep=+0pt,
        /tikz/column sep=+2\tabcolsep,
        /tikz/row sep=+0pt,
    },
    style/better tabular/.style={
        /pgf/inner xsep=+.5\tabcolsep,
        /pgf/inner ysep=+0.85ex,
        /tikz/column sep=+0pt,
        /tikz/row sep=+0pt,
        /pgf/outer xsep=+0pt,
        /pgf/outer ysep=+0pt,
    },
    @find heighest column in row/.code={%
    },
    @vertical line/.style args={#1#2#3#4#5-#6}{
        /utils/exec=%
            \def\tikz@temp{#5}%
            \pgfutil@ifxempty\tikz@temp
                {\def\tikzext@matrixplus@start{1}}
                {\pgfmathtruncatemacro\tikzext@matrixplus@start{\tikz@temp}}%
            \def\tikz@temp{#6}%
            \pgfutil@ifxempty\tikz@temp{%
                \let\tikzext@matrixplus@end\tikzext@matrixplus@lastrow
            }{%
                \pgfmathtruncatemacro\tikzext@matrixplus@end{\tikz@temp}%
            }
            ,
        insert path={
            (\tikzext@matrixplus@name-\tikzext@matrixplus@start-#2-bounding box#3)
            edge[matrix-plus/vertical line,#1]
            (\tikzext@matrixplus@name-\tikzext@matrixplus@end-#2-bounding box#4)}
    },
    heavyrule/.style={/tikz/line width=+.08em},
    lightrule/.style={/tikz/line width=+.05em},
    cmidrule/.style={/tikz/line width=+.03em},
    vertical line/.style=line to,
    horizontal line/.style={matrix-plus/cmidrule,line to},
    bottomrule line/.style=matrix-plus/heavyrule,
    toprule line/.style=matrix-plus/heavyrule,
    rule line/.style=thin,
    bottomrule/.default=,
    bottomrule/.code={%
        \tikzext@matrixplus@parse@rule{matrix-plus/bottomrule line}{\noexpand\tikzext@matrixplus@lastrow}{.south west}{.south east}{yshift=+-.5\pgflinewidth}#1\tikz@stop
    },
    toprule/.default=,
    toprule/.code={%
        \tikzext@matrixplus@parse@rule{matrix-plus/toprule line}{1}{.north west}{.north east}{yshift=+.5\pgflinewidth}#1\tikz@stop
    },
    rule/.value required,
    rule/.code 2 args={%
        \tikzext@matrixplus@parse@rule{matrix-plus/rule line}{#1}{.south west}{.south east}{}#2\tikz@stop
    },
    @horizontal line/.style args={#1#2#3#4#5#6-#7}{
        /utils/exec=%
            \def\tikz@temp{#6}%
            \pgfutil@ifxempty\tikz@temp
                {\def\tikzext@matrixplus@start{1}}
                {\pgfmathtruncatemacro\tikzext@matrixplus@start{\tikz@temp}}%
            \def\tikz@temp{#7}%
            \pgfutil@ifxempty\tikz@temp
                {\let\tikzext@matrixplus@end\tikzext@matrixplus@lastcol}
                {\pgfmathtruncatemacro\tikzext@matrixplus@end{\tikz@temp}},
        insert path={
            ([#5]\tikzext@matrixplus@name-#2-\tikzext@matrixplus@start-bounding box#3)
            edge[matrix-plus/horizontal line,#1]
            ([#5]\tikzext@matrixplus@name-#2-\tikzext@matrixplus@end-bounding box#4)}
    }
}
\def\tikzext@matrixplus@parse@rule#1#2#3#4#5{%
    \def\tikz@temp##1{{#1,##1}{#2}{#3}{#4}{#5}}%
    \pgfutil@ifnextchar[\tikzext@matrixplus@parse@rule@options{\tikzext@matrixplus@parse@rule@options[]}%
}
\def\tikzext@matrixplus@parse@rule@options[#1]{%
    \pgfutil@ifnextchar({\tikzext@matrixplus@parse@rule@final{#1}}{\tikzext@matrixplus@parse@rule@final{#1}(-)}%
}
\def\tikzext@matrixplus@parse@rule@final#1(#2)#3\tikz@stop{%
    \edef\tikz@temp{,matrix-plus/@horizontal line={\tikz@temp{#1}#2}}
    \expandafter\pgfutil@g@addto@macro\expandafter\tikzext@matrixplus@aftermatrix\expandafter{\tikz@temp}%
}

\let\tikzext@matrixplus@addtextdepth\pgfutil@empty
\let\tikzext@matrixplus@addtextheight\pgfutil@empty
\pgfutil@prefixto@macro\pgf@sh@s@rectangle{%
  \pgfutil@ifxempty\tikzext@matrixplus@addtextdepth{}{%
    \pgfmathsetlength\pgfutil@tempdima{\tikzext@matrixplus@addtextdepth}%
    \advance\dp\pgfnodeparttextbox by\pgfutil@tempdima
  }%
  \pgfutil@ifxempty\tikzext@matrixplus@addtextheight{}{%
    \pgfmathsetlength\pgfutil@tempdima{\tikzext@matrixplus@addtextheight}%
    \advance\ht\pgfnodeparttextbox by\pgfutil@tempdima
  }%
}%
\endinput